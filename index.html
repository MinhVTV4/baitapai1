<!DOCTYPE html>
<html lang="vi" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý AI v3 - Nền tảng Học tập Hiện đại</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- KA-TEX LIBRARIES FOR MATH FORMULAS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- MODERN UI THEME --- */
        :root {
            --background: 240 5% 96%; /* hsl(240, 5%, 96%) */
            --foreground: 240 6% 10%; /* hsl(240, 6%, 10%) */
            --card: 0 0% 100%;
            --card-foreground: 240 6% 10%;
            --primary: 240 5.9% 10%;
            --primary-foreground: 0 0% 98%;
            --secondary: 240 4.8% 95.9%;
            --secondary-foreground: 240 5.9% 10%;
            --accent: 240 4.8% 95.9%;
            --accent-foreground: 240 5.9% 10%;
            --border: 240 5.9% 90%;
            --input: 240 5.9% 90%;
            --ring: 240 5.9% 10%;
            --radius: 0.75rem;
        }

        .dark {
            --background: 240 6% 10%;
            --foreground: 0 0% 98%;
            --card: 240 6% 10%;
            --card-foreground: 0 0% 98%;
            --primary: 0 0% 98%;
            --primary-foreground: 240 5.9% 10%;
            --secondary: 240 3.7% 15.9%;
            --secondary-foreground: 0 0% 98%;
            --accent: 240 3.7% 15.9%;
            --accent-foreground: 0 0% 98%;
            --border: 240 3.7% 15.9%;
            --input: 240 3.7% 15.9%;
            --ring: 240 4.9% 83.9%;
        }

        body { 
            font-family: 'Be Vietnam Pro', sans-serif; 
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            transition: background-color 0.3s, color 0.3s;
        }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Card Style */
        .card {
            background-color: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border-radius: var(--radius);
            border: 1px solid hsl(var(--border));
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }
        
        /* Custom Input/Select Style */
        .input-base {
            background-color: hsl(var(--secondary));
            border: 1px solid hsl(var(--border));
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }
        .input-base:focus {
            outline: none;
            border-color: hsl(var(--ring));
            box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
        }

        /* Custom Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.25rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary {
            background-color: hsl(var(--primary));
            color: hsl(var(--primary-foreground));
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-secondary {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--border));
        }
        .btn-secondary:hover {
            background-color: hsl(var(--accent));
        }
        .btn-ghost {
            background-color: transparent;
            color: hsl(var(--foreground));
        }
        .btn-ghost:hover {
            background-color: hsl(var(--accent));
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Question Item Styling */
        .question-item {
            background-color: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        /* Radio & Checkbox */
        .custom-radio {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid hsl(var(--border));
            border-radius: 50%;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            top: 2px;
            flex-shrink: 0;
        }
        .custom-radio:checked {
            border-color: #3b82f6; /* Blue 500 */
            background-color: #3b82f6;
        }
        .custom-radio:checked::after {
            content: '';
            display: block;
            width: 0.5rem;
            height: 0.5rem;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .option-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .option-label:hover {
            background-color: hsl(var(--accent));
        }
        .option-label.correct {
            background-color: #dcfce7; /* Green 100 */
            border-color: #22c55e; /* Green 500 */
            color: #15803d; /* Green 700 */
        }
        .dark .option-label.correct {
            background-color: #14532d;
            border-color: #22c55e;
            color: #dcfce7;
        }
        .option-label.incorrect {
            background-color: #fee2e2; /* Red 100 */
            border-color: #ef4444; /* Red 500 */
            color: #b91c1c; /* Red 700 */
        }
        .dark .option-label.incorrect {
            background-color: #7f1d1d;
            border-color: #ef4444;
            color: #fee2e2;
        }

        /* Feedback Boxes */
        .feedback-box {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            border-left-width: 4px;
        }
        .feedback-box.correct {
            background-color: #f0fdf4; /* Green 50 */
            border-color: #22c55e; /* Green 500 */
            color: #166534; /* Green 800 */
        }
        .dark .feedback-box.correct {
            background-color: #14532d;
            color: #dcfce7;
        }
        .feedback-box.incorrect {
            background-color: #fef2f2; /* Red 50 */
            border-color: #ef4444; /* Red 500 */
            color: #991b1b; /* Red 800 */
        }
        .dark .feedback-box.incorrect {
            background-color: #7f1d1d;
            color: #fee2e2;
        }
        .feedback-box.info {
            background-color: #eff6ff; /* Blue 50 */
            border-color: #3b82f6; /* Blue 500 */
            color: #1e40af; /* Blue 800 */
        }
        .dark .feedback-box.info {
            background-color: #1e3a8a;
            color: #dbeafe;
        }

        /* Conversation Bubbles */
        .bubble {
            padding: 0.75rem 1.25rem;
            border-radius: 1.25rem;
            max-width: 80%;
            line-height: 1.6;
            width: fit-content;
        }
        .bubble-ai {
            background-color: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        .bubble-user {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }

        /* Writing Feedback */
        .prose-feedback del {
            background-color: #fee2e2; /* Red 100 */
            text-decoration: none;
            padding: 1px 2px;
            border-radius: 3px;
            color: #991b1b;
        }
        .dark .prose-feedback del {
            background-color: #7f1d1d;
            color: #fecaca;
        }
        .prose-feedback ins {
            background-color: #dcfce7; /* Green 100 */
            text-decoration: none;
            padding: 1px 2px;
            border-radius: 3px;
            color: #166534;
        }
        .dark .prose-feedback ins {
            background-color: #166534;
            color: #bbf7d0;
        }

        /* Katex Responsiveness */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
        }

        /* Tab styling */
        .tab-btn.active {
            border-color: #4f46e5; /* Indigo 500 */
            color: #4f46e5;
            background-color: #eef2ff; /* Indigo 50 */
        }
        .dark .tab-btn.active {
            color: #a5b4fc; /* Indigo 300 */
            border-color: #a5b4fc;
            background-color: #3730a3; /* Indigo 800 */
        }
        
        /* Modal Styling */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: hsl(var(--card));
            padding: 2rem; border-radius: 1rem; width: 90%;
            max-width: 600px; max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
    </style>
</head>
<body class="text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <div id="app-container" class="container mx-auto p-4 md:p-6 max-w-7xl">
        <!-- AUTHENTICATION HEADER -->
        <div id="auth-header" class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <i data-lucide="brain-circuit" class="w-8 h-8 text-indigo-500"></i>
                <span class="font-bold text-xl">EduAI</span>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle-btn" class="btn btn-ghost p-2">
                    <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                </button>
                <div id="user-info" class="hidden items-center gap-4">
                    <button id="history-btn" class="btn btn-secondary text-sm"><i data-lucide="history" class="w-4 h-4 mr-2"></i>Lịch sử</button>
                    <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                    <div class="text-sm">
                        <div class="font-semibold" id="user-name"></div>
                        <button id="logout-btn" class="text-xs text-gray-500 dark:text-gray-400 hover:underline">Đăng xuất</button>
                    </div>
                </div>
                <div id="login-container">
                    <button id="login-btn" class="btn btn-primary flex items-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                        <span>Đăng nhập</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- SETTINGS VIEW (VIEW 1) -->
        <div id="controls-view">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white mt-4">Trợ lý Giáo dục AI</h1>
                <p class="text-lg text-gray-500 dark:text-gray-400 mt-2 max-w-2xl mx-auto">Kiến tạo bài tập & Luyện tập kỹ năng chuyên biệt theo yêu cầu của bạn.</p>
            </header>
            <main>
                <div id="controls" class="card p-6 md:p-8 max-w-4xl mx-auto">
                    <div class="mb-8 pb-6 border-b border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4 flex items-center"><i data-lucide="swords" class="w-5 h-5 mr-3 text-indigo-500"></i>Chọn chế độ làm bài</h2>
                        <div class="flex items-center bg-gray-100 dark:bg-gray-800 p-1 rounded-xl max-w-md mx-auto">
                            <button id="mode-practice-btn" class="w-1/2 p-2 rounded-lg font-semibold text-sm transition-all bg-white dark:bg-gray-900 text-indigo-600 dark:text-indigo-400 shadow">Luyện tập</button>
                            <button id="mode-interactive-btn" class="w-1/2 p-2 rounded-lg font-semibold text-sm transition-all text-gray-500 dark:text-gray-400">Tương tác</button>
                        </div>
                        <input type="hidden" id="mode-select" value="practice">
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
                        <div class="space-y-6">
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="settings-2" class="w-5 h-5 mr-3 text-indigo-500"></i>1. Cài đặt chung</h2>
                            <div>
                                <label for="subject-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Môn học</label>
                                <select id="subject-select" class="input-base">
                                    <option value="general">Môn học chung</option>
                                    <option value="english">Tiếng Anh</option>
                                    <option value="mathematics">Toán</option>
                                </select>
                            </div>
                            <div id="skill-select-container" class="hidden">
                                <label for="skill-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kỹ năng</label>
                                <select id="skill-select" class="input-base">
                                    <option value="vocabulary">Từ vựng</option>
                                    <option value="grammar">Ngữ pháp</option>
                                    <option value="reading">Đọc hiểu</option>
                                    <option value="listening">Nghe hiểu</option>
                                    <option value="writing">Luyện viết</option>
                                    <option value="conversation">Hội thoại</option>
                                </select>
                            </div>
                            <div id="math-level-select-container" class="hidden">
                                <label for="math-level-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cấp độ</label>
                                <select id="math-level-select" class="input-base">
                                    <option value="intermediate">Lớp 6-9 (Cơ bản)</option>
                                    <option value="advanced">Lớp 10-12 (Trung bình)</option>
                                    <option value="expert">Nâng cao (Khó)</option>
                                </select>
                            </div>
                            <div id="level-select-container" class="hidden">
                                <label for="level-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cấp độ (CEFR)</label>
                                <select id="level-select" class="input-base">
                                    <option value="A2">A2 (Sơ cấp)</option>
                                    <option value="B1" selected>B1 (Trung cấp)</option>
                                    <option value="B2">B2 (Trung-cao cấp)</option>
                                    <option value="C1">C1 (Cao cấp)</option>
                                    <option value="C2">C2 (Thành thạo)</option>
                                </select>
                            </div>
                        </div>
                        <div id="dynamic-controls-container" class="space-y-6"></div>
                    </div>
                    <div class="mt-10 pt-6 border-t border-gray-200 dark:border-gray-700 text-center">
                        <button id="generateButton" class="btn btn-primary w-full md:w-auto text-base py-3 px-10 transform hover:-translate-y-1">
                            <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i>
                            <span id="buttonText">Bắt đầu Luyện tập</span>
                            <svg id="buttonSpinner" class="spinner h-5 w-5 text-white hidden ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </div>
                </div>
                 <div id="statusMessage" class="mt-6 text-center font-semibold"></div>
            </main>
        </div>

        <!-- EXERCISE VIEW (VIEW 2) -->
        <div id="exercise-view" class="hidden">
             <div class="max-w-4xl mx-auto">
                <div class="card p-6 md:p-8 mb-6">
                    <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white">BÀI KIỂM TRA</h2>
                    <div class="mt-6 text-center border-t border-b border-gray-200 dark:border-gray-700 py-4">
                        <div id="paper-subject" class="font-bold text-indigo-600 dark:text-indigo-400"></div>
                        <div id="paper-details" class="text-sm text-gray-500 dark:text-gray-400 mt-1"></div>
                        <div id="paper-score" class="hidden font-bold mt-2 text-2xl text-green-600 dark:text-green-400"></div>
                    </div>
                </div>

                <!-- NEW: AUDIO PLAYER CONTAINER -->
                <div id="audio-player-container" class="hidden mb-6 card p-4">
                    <h3 class="font-bold mb-3 text-lg text-gray-800 dark:text-gray-200">Bài nghe</h3>
                    <div class="flex items-center gap-4">
                        <button id="play-audio-btn" class="bg-sky-500 hover:bg-sky-600 text-white p-3 rounded-full shadow-md">
                            <i data-lucide="play" class="w-6 h-6"></i>
                        </button>
                        <div id="audio-status" class="font-semibold text-gray-600 dark:text-gray-300">Nhấn để nghe</div>
                    </div>
                    <button id="show-transcript-btn" class="text-sm text-sky-600 hover:underline mt-3">Hiện lời thoại</button>
                    <div id="transcript-container" class="hidden mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded text-gray-600 dark:text-gray-300 text-sm italic"></div>
                </div>

                <!-- Practice Mode -->
                <div id="practice-mode-container">
                    <div id="exercise-list-container"></div>
                    <div id="practice-footer" class="mt-8 text-center">
                        <button id="checkAllAnswersButton" class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-lg py-3 px-8">
                            Chấm bài
                        </button>
                        <div id="practice-actions-container" class="hidden mt-4 flex justify-center gap-4">
                            <button id="restart-practice-btn" class="btn btn-primary"><i data-lucide="rotate-cw" class="w-5 h-5 mr-2 inline-block"></i>Làm lại</button>
                            <button id="change-settings-from-practice-btn" class="btn btn-secondary"><i data-lucide="sliders-horizontal" class="w-5 h-5 mr-2 inline-block"></i>Đổi cài đặt</button>
                        </div>
                    </div>
                </div>
                <!-- Interactive Mode -->
                <div id="interactive-mode-container" class="hidden">
                    <div id="interactive-header" class="flex justify-between items-center mb-4 p-4 card">
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="font-semibold text-gray-600 dark:text-gray-300 text-sm whitespace-nowrap ml-4">
                            <span id="progress-text">Câu 0 / 0</span>
                        </div>
                    </div>
                    <div id="interactive-passage-host" class="mb-6"></div>
                    <div id="interactive-question-host" class="fade-in"></div>
                    <div id="interactive-footer" class="mt-6 text-center"></div>
                </div>
             </div>
        </div>
        
        <!-- NEW: WRITING VIEW -->
        <div id="writing-view" class="hidden max-w-4xl mx-auto">
            <div class="card p-6 md:p-8">
                <h2 id="writing-topic" class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white">Chủ đề Viết</h2>
                <textarea id="writing-input" class="input-base w-full min-h-[300px]" placeholder="Viết bài của bạn ở đây..."></textarea>
                <div id="writing-footer">
                    <div class="text-right my-4 font-semibold text-gray-600 dark:text-gray-400" id="word-count">0 từ</div>
                    <button id="get-feedback-btn" class="btn btn-primary w-full">
                        <span class="btn-text">Nhận phản hồi từ AI</span>
                        <svg class="spinner h-5 w-5 text-white hidden ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <div id="writing-feedback-container" class="mt-8 space-y-4 prose-feedback"></div>
                    <div id="writing-actions-container" class="hidden mt-4 flex justify-center gap-4">
                        <button id="restart-writing-btn" class="btn btn-primary"><i data-lucide="rotate-cw" class="w-5 h-5 mr-2 inline-block"></i>Làm lại</button>
                        <button id="change-settings-from-writing-btn" class="btn btn-secondary"><i data-lucide="sliders-horizontal" class="w-5 h-5 mr-2 inline-block"></i>Đổi cài đặt</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: CONVERSATION VIEW -->
        <div id="conversation-view" class="hidden max-w-4xl mx-auto">
            <div class="card p-6 md:p-8">
                <h2 id="conversation-topic" class="text-2xl font-bold text-center mb-4 text-gray-800 dark:text-white">Hội thoại thực hành</h2>
                <div id="conversation-log" class="h-96 overflow-y-auto p-4 bg-gray-100 dark:bg-gray-800 rounded-lg mb-4 flex flex-col gap-4">
                    <!-- Messages will be appended here -->
                </div>
                <div id="conversation-footer">
                    <div id="conversation-input-area" class="flex gap-4 items-center">
                        <input type="text" id="conversation-text-input" class="input-base flex-grow" placeholder="Gõ câu trả lời...">
                        <button id="send-text-btn" class="btn btn-primary bg-blue-600 hover:bg-blue-700 p-3 rounded-lg"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                    <button id="end-conversation-btn" class="btn bg-red-600 hover:bg-red-700 text-white w-full mt-6">Kết thúc & Nhận xét</button>
                </div>
            </div>
        </div>


        <!-- SUMMARY VIEW (VIEW 3) -->
        <div id="summary-view" class="hidden">
            <div class="text-center max-w-2xl mx-auto card p-8 fade-in">
                <i data-lucide="award" class="w-20 h-20 text-amber-500 mx-auto"></i>
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white mt-4">Hoàn thành!</h2>
                <p id="summary-text" class="text-lg text-gray-600 dark:text-gray-400 mt-2">Bạn đã trả lời đúng 0/0 câu.</p>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 my-6"><div id="summary-progress-bar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-4 rounded-full" style="width: 0%"></div></div>
                <div id="summary-save-status" class="text-sm text-gray-500 dark:text-gray-400 mb-6"></div>
                <div class="flex justify-center gap-4 mt-8">
                    <button id="restart-quiz-btn" class="btn btn-primary"><i data-lucide="rotate-cw" class="w-5 h-5 mr-2 inline-block"></i>Làm lại</button>
                    <button id="change-settings-btn" class="btn btn-secondary"><i data-lucide="sliders-horizontal" class="w-5 h-5 mr-2 inline-block"></i>Đổi cài đặt</button>
                </div>
            </div>
        </div>
        
        <!-- HISTORY VIEW (VIEW 4) -->
        <div id="history-view" class="hidden">
            <div class="card p-6 md:p-8">
                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-4 mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Lịch sử làm bài</h2>
                    <button id="back-to-main-btn" class="btn btn-secondary"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Quay lại</button>
                </div>

                <!-- Tabs for history -->
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="practice-tab" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Luyện tập</button>
                        <button id="interactive-tab" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-600">Tương tác</button>
                    </nav>
                </div>

                <div id="history-loading-spinner" class="text-center py-10 hidden">
                    <svg class="spinner h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-2 font-semibold">Đang tải lịch sử...</p>
                </div>

                <!-- Practice History Content -->
                <div id="practice-history-content">
                    <div id="practice-history-list" class="space-y-4 mt-6"></div>
                    <div id="no-practice-history" class="text-center py-10 text-gray-500 hidden">
                        <i data-lucide="archive-x" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>Chưa có lịch sử luyện tập nào.</p>
                    </div>
                </div>

                <!-- Interactive History Content -->
                <div id="interactive-history-content" class="hidden">
                    <div id="interactive-history-list" class="space-y-4 mt-6"></div>
                    <div id="no-interactive-history" class="text-center py-10 text-gray-500 hidden">
                        <i data-lucide="archive-x" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>Chưa có lịch sử tương tác nào.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL FOR LESSONS (EXPAND/REINFORCE) -->
    <div id="lesson-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700 mb-4">
                <h3 id="lesson-title" class="text-2xl font-bold">Bài học từ AI</h3>
                <button id="close-lesson-modal" class="text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="lesson-content" class="space-y-4">
                <div class="spinner mx-auto"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script type="module">
        // --- Firebase and Gemini Initialization ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhWdltKbJScRhhCW3FW1Hv1aza5U2Eb6Y",
            authDomain: "aibaitap-lien.firebaseapp.com",
            projectId: "aibaitap-lien",
            storageBucket: "aibaitap-lien.appspot.com",
            messagingSenderId: "956841572004",
            appId: "1:956841572004:web:f665c7de5a7ae1312c9831"
        };

        const app = initializeApp(firebaseConfig);
        let model;
        const GEMINI_MODEL_NAME = "gemini-2.5-flash";
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- DOM Elements ---
        const controlsView = document.getElementById('controls-view');
        const exerciseView = document.getElementById('exercise-view');
        const summaryView = document.getElementById('summary-view');
        const historyView = document.getElementById('history-view');
        const writingView = document.getElementById('writing-view');
        const conversationView = document.getElementById('conversation-view');
        
        const authHeader = document.getElementById('auth-header');
        const loginContainer = document.getElementById('login-container');
        const loginBtn = document.getElementById('login-btn');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');
        const historyBtn = document.getElementById('history-btn');
        
        const backToMainBtn = document.getElementById('back-to-main-btn');
        const historyLoadingSpinner = document.getElementById('history-loading-spinner');
        
        const practiceTab = document.getElementById('practice-tab');
        const interactiveTab = document.getElementById('interactive-tab');
        const practiceHistoryContent = document.getElementById('practice-history-content');
        const interactiveHistoryContent = document.getElementById('interactive-history-content');
        const practiceHistoryList = document.getElementById('practice-history-list');
        const interactiveHistoryList = document.getElementById('interactive-history-list');
        const noPracticeHistory = document.getElementById('no-practice-history');
        const noInteractiveHistory = document.getElementById('no-interactive-history');

        const lessonModal = document.getElementById('lesson-modal');
        const lessonTitle = document.getElementById('lesson-title');
        const lessonContent = document.getElementById('lesson-content');
        const closeLessonModal = document.getElementById('close-lesson-modal');

        const modeSelect = document.getElementById('mode-select');
        const modePracticeBtn = document.getElementById('mode-practice-btn');
        const modeInteractiveBtn = document.getElementById('mode-interactive-btn');
        const subjectSelect = document.getElementById('subject-select');
        const skillSelectContainer = document.getElementById('skill-select-container');
        const skillSelect = document.getElementById('skill-select');
        const mathLevelSelectContainer = document.getElementById('math-level-select-container');
        const mathLevelSelect = document.getElementById('math-level-select');
        const levelSelectContainer = document.getElementById('level-select-container');
        const levelSelect = document.getElementById('level-select'); 
        const dynamicControlsContainer = document.getElementById('dynamic-controls-container');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const statusMessage = document.getElementById('statusMessage');
        
        // Exercise View Elements
        const audioPlayerContainer = document.getElementById('audio-player-container');
        const playAudioBtn = document.getElementById('play-audio-btn');
        const audioStatus = document.getElementById('audio-status');
        const showTranscriptBtn = document.getElementById('show-transcript-btn');
        const transcriptContainer = document.getElementById('transcript-container');
        const practiceModeContainer = document.getElementById('practice-mode-container');
        const exerciseListContainer = document.getElementById('exercise-list-container');
        const practiceFooter = document.getElementById('practice-footer');
        const checkAllAnswersButton = document.getElementById('checkAllAnswersButton');
        const practiceActionsContainer = document.getElementById('practice-actions-container');
        const restartPracticeBtn = document.getElementById('restart-practice-btn');
        const changeSettingsFromPracticeBtn = document.getElementById('change-settings-from-practice-btn');
        const interactiveModeContainer = document.getElementById('interactive-mode-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const interactiveQuestionHost = document.getElementById('interactive-question-host');
        const interactiveFooter = document.getElementById('interactive-footer');
        const paperSubject = document.getElementById('paper-subject');
        const paperDetails = document.getElementById('paper-details');
        const paperScore = document.getElementById('paper-score');
        
        // Writing View Elements
        const writingTopic = document.getElementById('writing-topic');
        const writingInput = document.getElementById('writing-input');
        const wordCount = document.getElementById('word-count');
        const getFeedbackBtn = document.getElementById('get-feedback-btn');
        const writingFeedbackContainer = document.getElementById('writing-feedback-container');
        const writingActionsContainer = document.getElementById('writing-actions-container');
        const restartWritingBtn = document.getElementById('restart-writing-btn');
        const changeSettingsFromWritingBtn = document.getElementById('change-settings-from-writing-btn');

        // Conversation View Elements
        const conversationTopic = document.getElementById('conversation-topic');
        const conversationLog = document.getElementById('conversation-log');
        const conversationInputArea = document.getElementById('conversation-input-area');
        const conversationTextInput = document.getElementById('conversation-text-input');
        const sendTextBtn = document.getElementById('send-text-btn');
        const endConversationBtn = document.getElementById('end-conversation-btn');

        // Summary View Elements
        const summaryText = document.getElementById('summary-text');
        const summaryProgressBar = document.getElementById('summary-progress-bar');
        const summarySaveStatus = document.getElementById('summary-save-status');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const changeSettingsBtn = document.getElementById('change-settings-btn');
        

        // --- State ---
        let allQuestions = [];
        let currentQuizData = {}; 
        let currentQuestionIndex = 0;
        let score = 0;
        let generatedExercisesCache = [];
        let currentUser = null;
        let currentTestResult = {};
        let sessionResults = [];
        let conversationHistory = [];
        const synth = window.speechSynthesis;
        let audioState = { utterance: null, isPaused: false };

        // --- Utility Functions ---
        function sanitizeString(str) {
            if (!str) return '';
            return str.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
        }

        function extractAndParseJson(rawText) {
            const regex = /```json\s*([\s\S]*?)\s*```/;
            const match = rawText.match(regex);
            let jsonString = (match && match[1]) ? match[1] : rawText;
            jsonString = jsonString.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, '');
            try { return JSON.parse(jsonString); } 
            catch (error) { console.error("JSON Parse Error:", error, "String:", jsonString); return null; }
        }

        // --- AI TOOLBOX ---
        const tools = [{ functionDeclarations: [ { name: 'createMultipleChoiceQuestion', description: 'Tạo một câu hỏi trắc nghiệm.', parameters: { type: 'OBJECT', properties: { question: { type: 'STRING' }, options: { type: 'ARRAY', items: { type: 'STRING' } }, correctAnswerIndex: { type: 'NUMBER' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['question', 'options', 'correctAnswerIndex', 'explanation'] } }, { name: 'createFillInTheBlankQuestion', description: 'Tạo một câu hỏi điền vào chỗ trống.', parameters: { type: 'OBJECT', properties: { question: { type: 'STRING' }, correctAnswer: { type: 'STRING' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['question', 'correctAnswer', 'explanation'] } }, { name: 'createTrueFalseQuestion', description: 'Tạo một câu hỏi dạng Đúng hoặc Sai.', parameters: { type: 'OBJECT', properties: { statement: { type: 'STRING' }, isCorrect: { type: 'BOOLEAN' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['statement', 'isCorrect', 'explanation'] } }, { name: 'createMatchingQuestion', description: 'Tạo một bài tập nối cột.', parameters: { type: 'OBJECT', properties: { title: { type: 'STRING' }, columnA: { type: 'ARRAY', items: { type: 'STRING' } }, columnB: { type: 'ARRAY', items: { type: 'STRING' } } }, required: ['title', 'columnA', 'columnB'] } }, { name: 'createSortingQuestion', description: 'Tạo một bài tập sắp xếp các mục theo đúng thứ tự.', parameters: { type: 'OBJECT', properties: { title: { type: 'STRING' }, items: { type: 'ARRAY', items: { type: 'STRING' }, description: 'Mảng các mục đã ở đúng thứ tự.' } }, required: ['title', 'items'] } }, { name: 'createShortAnswerQuestion', description: 'Tạo một câu hỏi tự luận ngắn.', parameters: { type: 'OBJECT', properties: { question: { type: 'STRING' }, suggestedAnswer: { type: 'STRING' } }, required: ['question', 'suggestedAnswer'] } }, { name: 'createEnglishReadingComprehensionExercise', description: 'Tạo một bài tập đọc hiểu Tiếng Anh hoàn chỉnh.', parameters: { type: 'OBJECT', properties: { passage: { type: 'STRING' }, questions: { type: 'ARRAY', items: { type: 'OBJECT', properties: { questionType: { type: 'STRING', enum: ['mcq', 'short_answer'] }, questionText: { type: 'STRING' }, options: { type: 'ARRAY', items: { type: 'STRING' } }, correctAnswer: { type: 'STRING' }, explanation: { type: 'STRING', description: 'Giải thích ngắn gọn tại sao đáp án lại đúng.' } }, required: ['questionType', 'questionText', 'correctAnswer'] } } }, required: ['passage', 'questions'] } } ] }];
        
        // --- PROMPTS ---
        function getListeningPrompt(level, topic, count, length) { 
            const lengthMap = { short: '50-80 words', medium: '90-120 words', long: '130-160 words' };
            return `You are an expert English teacher. Create a listening comprehension quiz. 1. Generate one monologue or dialogue of about ${lengthMap[length]}. The topic is "${topic}" and for a ${level} CEFR level learner. 2. Based on the script, generate ${count} multiple-choice questions. 3. For each question, provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. The "answer" field MUST be the full text of the correct option. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON object: \`\`\`json\n{ "script": "...", "questions": [ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ] }\n\`\`\``; 
        }
        function getWritingTopicPrompt(level, topic) { 
            return `You are an English teacher. Generate a single, engaging writing topic for an English learner at the ${level} CEFR level. The topic should be related to "${topic}". The topic should be a question or a statement to respond to. Provide only the topic text, without any extra labels or quotation marks. Example: "Describe your favorite kind of technology and explain why you like it."`; 
        }
        function getWritingFeedbackPrompt(level, topic, userText) { 
            return `You are an expert English writing evaluator. A student at the ${level} CEFR level has written the following text about the topic "${topic}". IMPORTANT: The 'correctedTextHTML' field in your response MUST be a direct correction of the student's provided text below, using "<del>" and "<ins>" tags. Do not invent a new text. Student's text: """ ${userText} """ Please provide feedback in Vietnamese. You MUST wrap your entire response in a 'json' markdown code block. The JSON object must have the following structure: 1. "overallFeedback": A general comment in Vietnamese (2-3 sentences) on the text's content, clarity, and effort. 2. "score": An integer score from 0 to 100. 3. "correctedTextHTML": The student's original text with corrections applied. 4. "detailedFeedback": An array of objects, where each object explains a specific mistake. Each object should have: "type", "mistake", "correction", "explanation". Example of the required JSON output: \`\`\`json\n{ "overallFeedback": "...", "score": 75, "correctedTextHTML": "...", "detailedFeedback": [ { "type": "Grammar", "mistake": "...", "correction": "...", "explanation": "..." } ] }\n\`\`\``; 
        }
        function getConversationStartPrompt(topic) { 
            return `You are a friendly, encouraging English conversation partner. Start a conversation with the user about the topic: "${topic}". Ask a simple, open-ended question to begin. Keep your opening short and natural.`; 
        }
        function getConversationFollowUpPrompt(history, topic) { 
            return `You are a friendly, encouraging English conversation partner. The topic of conversation is "${topic}". Here is the conversation history so far:\n${history}\n\nBased on the user's last message, ask a natural, engaging follow-up question to keep the conversation going. Do not repeat questions. Keep your responses concise and friendly.`; 
        }
        function getConversationFeedbackPrompt(history, topic, level) { 
            return `You are an expert English teacher. A student at the ${level} CEFR level has just completed a practice conversation with you about "${topic}". Your goal is to provide constructive, encouraging feedback. Here is the full transcript:\n${history}\n\nPlease provide your feedback in Vietnamese. You MUST wrap your entire response in a 'json' markdown code block. The JSON object must have the following structure: 1. "overallFeedback": A friendly, encouraging summary (2-3 sentences) of their performance, highlighting what they did well. 2. "strengths": An array of 1-2 strings, listing positive points (e.g., "Sử dụng tốt từ vựng về du lịch", "Phát âm rõ ràng các âm cuối"). 3. "areasForImprovement": An array of objects, each highlighting a specific area for improvement. Each object should have: "type" (e.g., "Ngữ pháp", "Lựa chọn từ", "Lưu loát"), "original" (the user's original phrase), "suggestion" (a better way to phrase it), and "explanation" (a short, clear explanation in Vietnamese). Focus on the most important points, don't overwhelm the user. Example of the required JSON output: \`\`\`json { "overallFeedback": "...", "strengths": ["..."], "areasForImprovement": [ { "type": "Ngữ pháp", "original": "I go to the cinema yesterday.", "suggestion": "I went to the cinema yesterday.", "explanation": "Khi nói về quá khứ, chúng ta dùng thì quá khứ đơn 'went' thay vì 'go'." } ] } \`\`\``; 
        }

        function getReinforcementPrompt(questionArgs, userAnswer) {
            const questionText = questionArgs.question || questionArgs.statement || questionArgs.title;
            const correctAnswer = questionArgs.correctAnswer || (questionArgs.options ? questionArgs.options[questionArgs.correctAnswerIndex] : 'N/A');
            const currentSubject = subjectSelect.value;

            let prompt;
            if (currentSubject === 'english') {
                prompt = `Bạn là một gia sư AI tận tình. Một học sinh vừa trả lời SAI một câu hỏi. Hãy cung cấp một bài học **bằng tiếng Việt** để giúp họ hiểu rõ lỗi sai và củng cố kiến thức. Thông tin: - Câu hỏi: "${questionText}" - Câu trả lời sai của học sinh: "${userAnswer}" - Đáp án đúng: "${correctAnswer}". Câu trả lời của bạn BẮT BUỘC phải là một khối JSON được bọc trong markdown, có cấu trúc: { "conceptTitle": "...", "mistakeAnalysis": "...", "conceptExplanation": "...", "examples": [{ "en": "...", "vi": "..." }], "practiceTip": "..." }`;
            } else {
                prompt = `Bạn là một gia sư AI tận tình. Một học sinh vừa trả lời SAI một câu hỏi. Hãy cung cấp một bài học **bằng tiếng Việt** để giúp họ hiểu rõ lỗi sai và củng cố kiến thức. Thông tin: - Câu hỏi: "${questionText}" - Câu trả lời sai của học sinh: "${userAnswer}" - Đáp án đúng: "${correctAnswer}". Câu trả lời của bạn BẮT BUỘC phải là một khối JSON được bọc trong markdown, có cấu trúc: { "conceptTitle": "...", "mistakeAnalysis": "...", "conceptExplanation": "...", "examples": ["...", "..."], "practiceTip": "..." }`;
            }
            return prompt;
        }

        function getExpansionPrompt(questionArgs) {
             const questionText = questionArgs.question || questionArgs.statement || questionArgs.title;
            const currentSubject = subjectSelect.value;
            
            let prompt;
            if (currentSubject === 'english') {
                prompt = `Bạn là một gia sư AI thân thiện. Một học sinh vừa trả lời đúng câu hỏi sau: "${questionText}". Hãy khen ngợi họ và cung cấp một bài học mở rộng ngắn gọn **bằng tiếng Việt** để giúp họ hiểu sâu hơn về chủ đề liên quan. Câu trả lời của bạn BẮT BUỘC phải là một khối JSON được bọc trong markdown, có cấu trúc: { "conceptTitle": "...", "conceptExplanation": "...", "examples": [{ "en": "...", "vi": "..." }], "practiceTip": "..." }`;
            } else {
                prompt = `Bạn là một gia sư AI thân thiện. Một học sinh vừa trả lời đúng câu hỏi sau: "${questionText}". Hãy khen ngợi họ và cung cấp một bài học mở rộng ngắn gọn **bằng tiếng Việt** để giúp họ hiểu sâu hơn về chủ đề liên quan. Câu trả lời của bạn BẮT BUỘC phải là một khối JSON được bọc trong markdown, có cấu trúc: { "conceptTitle": "...", "conceptExplanation": "...", "examples": ["...", "..."], "practiceTip": "..." }`;
            }
            return prompt;
        }

        // --- TEMPLATES ---
        const commonExerciseTypesTemplate = `
            <fieldset>
                <legend class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Số lượng cho mỗi dạng bài:</legend>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                     <div><label for="mcqCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Trắc nghiệm</label><input type="number" id="mcqCount" value="1" min="0" class="input-base p-2 text-center"></div>
                    <div><label for="fibCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Điền từ</label><input type="number" id="fibCount" value="1" min="0" class="input-base p-2 text-center"></div>
                     <div><label for="tfCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Đúng/Sai</label><input type="number" id="tfCount" value="1" min="0" class="input-base p-2 text-center"></div>
                    <div><label for="matchingCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Nối cột</label><input type="number" id="matchingCount" value="0" min="0" class="input-base p-2 text-center"></div>
                    <div><label for="sortingCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Sắp xếp</label><input type="number" id="sortingCount" value="0" min="0" class="input-base p-2 text-center"></div>
                    <div><label for="saqCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Tự luận ngắn</label><input type="number" id="saqCount" value="0" min="0" class="input-base p-2 text-center"></div>
                </div>
            </fieldset>
        `;
        const controlTemplates = {
            general: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="edit-3" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh nội dung</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nhập chủ đề hoặc nội dung</label><textarea id="topicInput" rows="4" class="input-base" placeholder="Ví dụ: Lịch sử Việt Nam giai đoạn 1945-1954..."></textarea></div>${commonExerciseTypesTemplate}`,
            english_reading: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="book-open" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh bài đọc</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chủ đề bài đọc</label><input type="text" id="topicInput" class="input-base" placeholder="Ví dụ: The future of renewable energy"></div><fieldset class="mt-4"><legend class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Cấu hình bài đọc hiểu:</legend><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="md:col-span-1"><label for="passageLength" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Độ dài</label><select id="passageLength" class="input-base p-2"><option value="short">Ngắn (~150 từ)</option><option value="medium" selected>Vừa (~250 từ)</option><option value="long">Dài (~400 từ)</option></select></div><div class="md:col-span-1"><label for="readingMcqCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Câu trắc nghiệm</label><input type="number" id="readingMcqCount" value="2" min="0" class="input-base p-2 text-center"></div><div class="md:col-span-1"><label for="readingSaqCount" class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Câu tự luận</label><input type="number" id="readingSaqCount" value="1" min="0" class="input-base p-2 text-center"></div></div></fieldset>`,
            english_grammar: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="spell-check-2" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh ngữ pháp</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chủ điểm ngữ pháp</label><input type="text" id="topicInput" class="input-base" placeholder="Ví dụ: Present Perfect Tense, Passive Voice..."></div>${commonExerciseTypesTemplate}`,
            english_vocabulary: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="book-a" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh từ vựng</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chủ đề từ vựng</label><input type="text" id="topicInput" class="input-base" placeholder="Ví dụ: Travel, Technology, Environment..."></div>${commonExerciseTypesTemplate}`,
            english_listening: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="headphones" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh bài nghe</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chủ đề bài nghe</label><input type="text" id="topicInput" class="input-base" placeholder="Ví dụ: A conversation at a restaurant"></div><div class="grid grid-cols-2 gap-4 mt-4"><fieldset><legend class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Độ dài</legend><select id="scriptLength" class="input-base p-2"><option value="short">Ngắn</option><option value="medium" selected>Vừa</option><option value="long">Dài</option></select></fieldset><fieldset><legend class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Số câu hỏi</legend><input type="number" id="questionCount" value="3" min="1" max="5" class="input-base p-2 text-center"></fieldset></div>`,
            english_writing: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="file-pen-line" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh bài viết</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chủ đề bài viết</label><input type="text" id="topicInput" class="input-base" placeholder="Ví dụ: The advantages of remote work"></div>`,
            english_conversation: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="messages-square" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh hội thoại</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chủ đề hội thoại</label><input type="text" id="topicInput" class="input-base" placeholder="Ví dụ: Your last vacation"></div>`,
            mathematics: `<h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 pb-3 flex items-center"><i data-lucide="calculator" class="w-5 h-5 mr-3 text-indigo-500"></i>2. Tùy chỉnh nội dung</h2><div><label for="topicInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chủ đề toán học</label><textarea id="topicInput" rows="4" class="input-base" placeholder="Ví dụ: Phương trình bậc hai, Tích phân, Hình học không gian..."></textarea></div>${commonExerciseTypesTemplate}`
        };
        
        // --- CORE LOGIC ---
        function switchView(view) {
            controlsView.classList.add('hidden');
            exerciseView.classList.add('hidden');
            summaryView.classList.add('hidden');
            historyView.classList.add('hidden');
            writingView.classList.add('hidden');
            conversationView.classList.add('hidden');
            authHeader.classList.remove('hidden');

            if (view === 'controls') controlsView.classList.remove('hidden');
            if (view === 'exercise') exerciseView.classList.remove('hidden');
            if (view === 'summary') summaryView.classList.remove('hidden');
            if (view === 'history') historyView.classList.remove('hidden');
            if (view === 'writing') writingView.classList.remove('hidden');
            if (view === 'conversation') conversationView.classList.remove('hidden');
        }

        function resetQuizState() {
            allQuestions = [];
            currentQuizData = {};
            currentQuestionIndex = 0;
            score = 0;
            sessionResults = [];
            exerciseListContainer.innerHTML = '';
            interactiveQuestionHost.innerHTML = '';
            interactiveFooter.innerHTML = '';
            document.getElementById('interactive-passage-host').innerHTML = '';
            paperScore.classList.add('hidden');
            if (practiceActionsContainer) practiceActionsContainer.classList.add('hidden');
            if (checkAllAnswersButton) checkAllAnswersButton.style.display = 'block';
            summarySaveStatus.textContent = '';
            conversationHistory = [];
            conversationLog.innerHTML = '';
        }

        // Main controller function
        async function startPractice() {
            const subject = subjectSelect.value;
            if (subject === 'english') {
                const skill = skillSelect.value;
                switch(skill) {
                    case 'listening':
                        await startListeningPractice();
                        break;
                    case 'writing':
                        await startWritingPractice();
                        break;
                    case 'conversation':
                        await startConversationPractice();
                        break;
                    default:
                        await generateExercises();
                }
            } else {
                await generateExercises();
            }
        }

        // --- LISTENING FEATURE ---
        async function startListeningPractice() {
            if (!model) { updateStatus('error', "Mô hình AI chưa được khởi tạo."); return; }
            setLoadingState(true);
            resetQuizState();

            const topic = document.getElementById('topicInput').value.trim();
            const level = levelSelect.value;
            const count = document.getElementById('questionCount').value;
            const length = document.getElementById('scriptLength').value;

            if (!topic) {
                updateStatus('error', "Vui lòng nhập chủ đề cho bài nghe.");
                setLoadingState(false);
                return;
            }

            currentQuizData = { type: 'listening', topic, level, count, length };
            
            try {
                const prompt = getListeningPrompt(level, topic, count, length);
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const parsedData = extractAndParseJson(response.text());

                if (!parsedData || !parsedData.script || !parsedData.questions) {
                    throw new Error("AI không trả về dữ liệu bài nghe hợp lệ.");
                }
                
                currentQuizData.raw = parsedData;
                generatedExercisesCache = parsedData.questions; // Cache for restart
                
                switchView('exercise');
                renderListeningQuiz();

            } catch (error) {
                console.error("Error generating listening quiz:", error);
                updateStatus('error', `Đã có lỗi xảy ra: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        function renderListeningQuiz() {
            audioPlayerContainer.classList.remove('hidden');
            transcriptContainer.classList.add('hidden');
            transcriptContainer.textContent = currentQuizData.raw.script;
            showTranscriptBtn.textContent = 'Hiện lời thoại';
            setupAudioPlayer();

            if (modeSelect.value === 'practice') {
                practiceModeContainer.classList.remove('hidden');
                interactiveModeContainer.classList.add('hidden');
                renderPracticeMode(generatedExercisesCache);
            } else {
                practiceModeContainer.classList.add('hidden');
                interactiveModeContainer.classList.remove('hidden');
                renderInteractiveMode(generatedExercisesCache);
            }
        }

        // --- WRITING FEATURE ---
        async function startWritingPractice() {
            if (!model) { updateStatus('error', "Mô hình AI chưa được khởi tạo."); return; }
            setLoadingState(true);
            resetQuizState();

            const topic = document.getElementById('topicInput').value.trim();
            const level = levelSelect.value;
            if (!topic) {
                updateStatus('error', "Vui lòng nhập chủ đề bài viết.");
                setLoadingState(false);
                return;
            }
            currentQuizData = { type: 'writing', topic, level };

            try {
                const prompt = getWritingTopicPrompt(level, topic);
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const topicText = response.text();

                writingTopic.textContent = topicText;
                writingInput.value = '';
                wordCount.textContent = '0 từ';
                writingFeedbackContainer.innerHTML = '';
                getFeedbackBtn.disabled = false;
                writingInput.disabled = false;
                writingActionsContainer.classList.add('hidden');
                
                switchView('writing');
            } catch (error) {
                showError(`Không thể tạo chủ đề luyện viết. Lỗi: ${error.message}.`);
            } finally {
                setLoadingState(false);
            }
        }

        async function getWritingFeedback() {
            const userText = writingInput.value;
            if (userText.trim().split(/\s+/).length < 10) {
                alert("Vui lòng viết ít nhất 10 từ để nhận được phản hồi chất lượng.");
                return;
            }

            const button = getFeedbackBtn;
            const btnTextEl = button.querySelector('.btn-text');
            const spinnerEl = button.querySelector('.spinner');
            
            btnTextEl.textContent = 'AI đang phân tích...';
            spinnerEl.classList.remove('hidden'); 
            button.disabled = true; 
            writingInput.disabled = true;

            try {
                const { level, topic } = currentQuizData;
                const prompt = getWritingFeedbackPrompt(level, topic, userText);
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const feedbackData = extractAndParseJson(response.text());

                if (!feedbackData) {
                    throw new Error("AI không trả về phản hồi hợp lệ. Vui lòng thử lại.");
                }

                displayWritingFeedback(feedbackData);
                writingActionsContainer.classList.remove('hidden');

            } catch (error) {
                writingFeedbackContainer.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}</p>`;
            } finally {
                btnTextEl.textContent = 'Nhận phản hồi từ AI';
                spinnerEl.classList.add('hidden'); 
            }
        }

        function displayWritingFeedback(data) {
            writingFeedbackContainer.innerHTML = `
                <div class="bg-sky-100 dark:bg-sky-900 border-2 border-sky-300 dark:border-sky-700 rounded-xl p-6 text-center">
                    <p class="text-2xl font-semibold mb-2 text-sky-800 dark:text-sky-200">Điểm của bạn</p>
                    <p class="text-6xl font-bold text-sky-600 dark:text-sky-400">${data.score} / 100</p>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-2">Nhận xét chung</h4>
                    <p class="text-gray-700 dark:text-gray-300">${data.overallFeedback}</p>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-2">Bài viết đã sửa</h4>
                    <p class="text-lg leading-relaxed">${data.correctedTextHTML}</p>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-3">Phân tích chi tiết</h4>
                    <div class="space-y-3">
                        ${(data.detailedFeedback || []).map(item => `
                            <div class="p-3 rounded-md bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
                                <p class="font-semibold text-gray-700 dark:text-gray-300"><span class="text-sm font-bold py-0.5 px-2 rounded-full bg-amber-200 text-amber-800 dark:bg-amber-800 dark:text-amber-200">${item.type}</span></p>
                                <p class="text-red-600 dark:text-red-400 mt-2">Lỗi: <del>${item.mistake}</del></p>
                                <p class="text-green-600 dark:text-green-400">Sửa thành: <ins>${item.correction}</ins></p>
                                <p class="text-gray-600 dark:text-gray-400 mt-2 text-sm"><i>${item.explanation}</i></p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- CONVERSATION FEATURE ---
        async function startConversationPractice() {
            if (!model) { updateStatus('error', "Mô hình AI chưa được khởi tạo."); return; }
            setLoadingState(true);
            resetQuizState();

            const topic = document.getElementById('topicInput').value.trim();
            const level = levelSelect.value;
            if (!topic) {
                updateStatus('error', "Vui lòng nhập chủ đề hội thoại.");
                setLoadingState(false);
                return;
            }
            currentQuizData = { type: 'conversation', topic, level };
            conversationTopic.textContent = `Chủ đề: ${topic}`;

            try {
                const prompt = getConversationStartPrompt(topic);
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const aiResponse = response.text();
                
                addMessageToLog('ai', aiResponse);
                conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                
                switchView('conversation');
            } catch (error) {
                showError(`Không thể bắt đầu hội thoại. Lỗi: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        async function handleConversationResponse() {
            const userText = conversationTextInput.value.trim();
            if (!userText) return;

            addMessageToLog('user', userText);
            conversationHistory.push({ role: 'user', parts: [{ text: userText }] });
            conversationTextInput.value = '';
            conversationTextInput.disabled = true;
            sendTextBtn.disabled = true;

            try {
                const historyText = conversationHistory.map(h => `${h.role}: ${h.parts[0].text}`).join('\n');
                const prompt = getConversationFollowUpPrompt(historyText, currentQuizData.topic);
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const aiResponse = response.text();

                addMessageToLog('ai', aiResponse);
                conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });

            } catch (error) {
                addMessageToLog('ai', 'Rất tiếc, đã có lỗi xảy ra. Vui lòng thử lại.');
            } finally {
                conversationTextInput.disabled = false;
                sendTextBtn.disabled = false;
                conversationTextInput.focus();
            }
        }

        async function endConversationAndGetFeedback() {
            endConversationBtn.disabled = true;
            
            lessonModal.classList.add('active');
            lessonTitle.textContent = "Đang phân tích hội thoại...";
            lessonContent.innerHTML = '<div class="spinner mx-auto"></div>';

            try {
                const historyText = conversationHistory.map(h => `${h.role === 'model' ? 'AI' : 'User'}: ${h.parts[0].text}`).join('\n');
                const prompt = getConversationFeedbackPrompt(historyText, currentQuizData.topic, currentQuizData.level);
                
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const feedbackData = extractAndParseJson(response.text());

                if (!feedbackData) { throw new Error("AI không trả về nhận xét hợp lệ."); }
                
                displayConversationFeedback(feedbackData);

            } catch(error) {
                lessonContent.innerHTML = `<p class="text-red-500">Lỗi khi nhận phản hồi: ${error.message}</p>`;
            } finally {
                endConversationBtn.disabled = false;
            }
        }

        function addMessageToLog(sender, text) {
            const messageEl = document.createElement('div');
            messageEl.className = `bubble bubble-${sender}`;
            messageEl.textContent = text;
            conversationLog.appendChild(messageEl);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function displayConversationFeedback(data) {
            lessonTitle.textContent = "Nhận xét buổi hội thoại";
            lessonTitle.className = "text-2xl font-bold text-indigo-600 dark:text-indigo-400";
            
            lessonContent.innerHTML = `
                <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-md font-bold text-gray-800 dark:text-gray-200 mb-2">Nhận xét chung</h4>
                    <p class="text-gray-700 dark:text-gray-300">${data.overallFeedback}</p>
                </div>
                <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg border border-green-200 dark:border-green-700">
                    <h4 class="text-md font-bold text-green-800 dark:text-green-200 mb-2">Điểm mạnh 👍</h4>
                    <ul class="list-disc list-inside text-green-700 dark:text-green-300">
                        ${(data.strengths || []).map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
                <div class="bg-amber-100 dark:bg-amber-900 p-3 rounded-lg border border-amber-200 dark:border-amber-700">
                    <h4 class="text-md font-bold text-amber-800 dark:text-amber-200 mb-3">Gợi ý cải thiện 💡</h4>
                    <div class="space-y-3">
                        ${(data.areasForImprovement || []).map(item => `
                            <div class="p-3 rounded-md bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                                <p class="font-semibold text-gray-700 dark:text-gray-300"><span class="text-sm font-bold py-0.5 px-2 rounded-full bg-amber-200 text-amber-800 dark:bg-amber-800 dark:text-amber-200">${item.type}</span></p>
                                <p class="text-red-600 dark:text-red-400 mt-2">Bạn đã nói: <del>${item.original}</del></p>
                                <p class="text-green-600 dark:text-green-400">Gợi ý: <ins>${item.suggestion}</ins></p>
                                <p class="text-gray-600 dark:text-gray-400 mt-2 text-sm"><i>${item.explanation}</i></p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }


        async function generateExercises() {
            if (!model) { updateStatus('error', "Mô hình AI chưa được khởi tạo."); return; }
            setLoadingState(true);
            
            resetQuizState();
            currentTestResult = {};

            const subjectText = subjectSelect.options[subjectSelect.selectedIndex].text;
            const topicInput = document.getElementById('topicInput');
            const topic = topicInput ? topicInput.value.trim() : '';

            if (!topic) { updateStatus('error', "Vui lòng nhập chủ đề."); setLoadingState(false); return; }

            currentTestResult.subject = subjectText;
            currentTestResult.topic = topic;
            currentTestResult.mode = modeSelect.value;

            let prompt = `Luôn cung cấp một giải thích (explanation) bằng tiếng Việt cho mỗi câu hỏi được tạo ra. Quan trọng: Đối với câu hỏi điền vào chỗ trống (createFillInTheBlankQuestion), hãy đảm bảo rằng chuỗi câu hỏi (thuộc tính 'question') luôn chứa chính xác ba dấu gạch dưới ('___') để chỉ định vị trí cần điền. Đối với các công thức toán học, hãy luôn sử dụng định dạng KaTeX.`;
            
            let counts = {};
            let requestParts = [];

            if (subjectSelect.value === 'english') {
                const skillText = skillSelect.options[skillSelect.selectedIndex].text;
                const levelText = levelSelect.options[levelSelect.selectedIndex].text;
                const level = levelSelect ? levelSelect.value : 'B1';
                currentTestResult.details = `Kỹ năng: ${skillText} - Trình độ: ${levelText}`;
                
                if (skillSelect.value === 'reading') {
                     counts.readingMcq = document.getElementById('readingMcqCount').value;
                     counts.readingSaq = document.getElementById('readingSaqCount').value;
                     const passageLength = document.getElementById('passageLength').value;
                     prompt += `Hãy sử dụng công cụ 'createEnglishReadingComprehensionExercise'. Tạo một bài đọc hiểu Tiếng Anh về chủ đề "${topic}" cho trình độ ${level}, dài ở mức '${passageLength}'. Bài đọc cần có ${counts.readingMcq} câu hỏi trắc nghiệm và ${counts.readingSaq} câu hỏi tự luận ngắn.`;
                } else { 
                    prompt += `Tạo một bộ bài tập về chủ đề ${skillText} Tiếng Anh: "${topic}" cho trình độ ${level}. `;
                }
                 paperDetails.textContent = `Chủ đề: ${topic} - Trình độ: ${levelText}`;

            } else if (subjectSelect.value === 'mathematics') {
                const difficulty = mathLevelSelect.value;
                const difficultyText = mathLevelSelect.options[mathLevelSelect.selectedIndex].text;
                currentTestResult.details = `Cấp độ: ${difficultyText}`;
                prompt += `Dựa vào chủ đề toán học sau: "${topic}" cho cấp độ "${difficulty}", `;
                paperDetails.textContent = `Chủ đề: ${topic} - Cấp độ: ${difficultyText}`;

            } else { 
                currentTestResult.details = "Chủ đề chung";
                prompt += `Dựa vào chủ đề sau: "${topic}", `;
                paperDetails.textContent = `Chủ đề: ${topic}`;
            }

            if (subjectSelect.value !== 'english' || (subjectSelect.value === 'english' && skillSelect.value !== 'reading')) {
                counts.mcq = document.getElementById('mcqCount').value;
                counts.fib = document.getElementById('fibCount').value;
                counts.tf = document.getElementById('tfCount').value;
                counts.matching = document.getElementById('matchingCount').value;
                counts.sorting = document.getElementById('sortingCount').value;
                counts.saq = document.getElementById('saqCount').value;

                if (counts.mcq > 0) requestParts.push(`${counts.mcq} câu trắc nghiệm`);
                if (counts.fib > 0) requestParts.push(`${counts.fib} câu điền từ`);
                if (counts.tf > 0) requestParts.push(`${counts.tf} câu Đúng/Sai`);
                if (counts.matching > 0) requestParts.push(`${counts.matching} bài nối cột`);
                if (counts.sorting > 0) requestParts.push(`${counts.sorting} bài sắp xếp`);
                if (counts.saq > 0) requestParts.push(`${counts.saq} câu tự luận ngắn`);

                if (requestParts.length > 0) {
                     prompt += `Hãy sử dụng các công cụ được cung cấp để tạo ra: ${requestParts.join(', ')}.`;
                } else {
                    updateStatus('error', 'Vui lòng chọn ít nhất một dạng bài tập.');
                    setLoadingState(false);
                    return;
                }
            }

            try {
                const result = await model.generateContent({
                    contents: [{
                        role: 'user',
                        parts: [{ text: prompt }]
                    }],
                    tools: tools,
                });
                
                const functionCalls = result.response.functionCalls();
                
                if (!functionCalls || functionCalls.length === 0) {
                    updateStatus('error', "AI không thể tạo bài tập. Vui lòng thử lại với chủ đề khác hoặc số lượng ít hơn.");
                    return;
                }
                
                generatedExercisesCache = functionCalls;
                
                let flattenedItems = [];
                functionCalls.forEach(call => {
                    if (call.name === 'createEnglishReadingComprehensionExercise') {
                        flattenedItems.push({
                            name: 'reading_passage',
                            args: { passage: call.args.passage }
                        });
                        call.args.questions.forEach(subQ => {
                            let questionType, questionArgs;
                            if (subQ.questionType === 'mcq') {
                                const correctIndex = (subQ.options || []).indexOf(subQ.correctAnswer);
                                questionType = 'createMultipleChoiceQuestion';
                                questionArgs = {
                                    question: subQ.questionText,
                                    options: subQ.options,
                                    correctAnswerIndex: correctIndex !== -1 ? correctIndex : 0,
                                    explanation: subQ.explanation
                                };
                            } else if (subQ.questionType === 'short_answer') {
                                questionType = 'createShortAnswerQuestion';
                                questionArgs = {
                                    question: subQ.questionText,
                                    suggestedAnswer: subQ.correctAnswer
                                };
                            }
                            if (questionType) {
                                flattenedItems.push({ name: questionType, args: questionArgs });
                            }
                        });
                    } else {
                        flattenedItems.push(call);
                    }
                });
                allQuestions = flattenedItems;

                if (allQuestions.length === 0) {
                     updateStatus('error', "Không có bài tập hợp lệ nào được tạo.");
                     return;
                }

                paperSubject.innerHTML = `<strong>Môn học:</strong> ${subjectText}`;
                switchView('exercise');
                audioPlayerContainer.classList.add('hidden'); // Hide audio player for non-listening tasks

                if (modeSelect.value === 'practice') {
                    practiceModeContainer.classList.remove('hidden');
                    interactiveModeContainer.classList.add('hidden');
                    renderPracticeMode(allQuestions);
                } else {
                    practiceModeContainer.classList.add('hidden');
                    interactiveModeContainer.classList.remove('hidden');
                    renderInteractiveMode(allQuestions);
                }

            } catch (error) {
                console.error("Error calling API:", error);
                updateStatus('error', `Đã có lỗi xảy ra: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        function renderMath(element = document.body) {
            if (window.renderMathInElement) {
                setTimeout(() => {
                    renderMathInElement(element, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }, 0);
            }
        }

        // --- RENDERERS ---
        const renderers = { 
            'createMultipleChoiceQuestion': renderMultipleChoice, 
            'createFillInTheBlankQuestion': renderFillInTheBlank, 
            'createTrueFalseQuestion': renderTrueFalse, 
            'createMatchingQuestion': renderMatching, 
            'createSortingQuestion': renderSorting, 
            'createShortAnswerQuestion': renderShortAnswer, 
            'reading_passage': renderReadingPassage
        };
        
        function createQuestionItem(title, questionId) {
            const item = document.createElement('div');
            item.className = 'question-item';
            item.id = `q-${questionId}`;
            const titleDiv = document.createElement('div');
            titleDiv.className = 'font-bold text-lg mb-4 text-gray-800 dark:text-gray-200';
            if (title) {
                titleDiv.innerHTML = sanitizeString(title);
            }
            item.appendChild(titleDiv);
            return item;
        }

        function createFeedbackDiv(explanation) { 
            const div = document.createElement('div'); 
            div.className = 'feedback-box hidden'; 
            div.innerHTML = sanitizeString(explanation); 
            return div; 
        }
        
        function renderReadingPassage(args, index) {
            const item = document.createElement('div');
            item.className = 'question-item';
            item.innerHTML = `
                <p class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-200"><strong>Đoạn văn:</strong> Đọc và trả lời các câu hỏi bên dưới.</p>
                <div class="p-4 my-4 bg-gray-100 dark:bg-gray-800 border-t border-b border-gray-200 dark:border-gray-700 rounded-lg">
                    <p class="text-justify leading-relaxed">${sanitizeString(args.passage).replace(/\n/g, '</p><p class="mt-4 text-justify leading-relaxed">')}</p>
                </div>
            `;
            return item;
        }

        function renderMultipleChoice(args, index) {
            const questionText = args.question;
            const title = `<strong>Câu ${index}:</strong> ${questionText}`;
            const item = createQuestionItem(title, index); item.dataset.type = 'mcq';
            
            const correctIndex = args.correctAnswerIndex ?? args.options.indexOf(args.answer);
            item.dataset.correct = correctIndex;
            
            const optionsContainer = document.createElement('div'); optionsContainer.className = 'space-y-2';
            if (args.options && Array.isArray(args.options)) {
                args.options.forEach((option, optionIndex) => { 
                    optionsContainer.innerHTML += `
                        <label for="q${index}-opt${optionIndex}" class="option-label">
                            <input id="q${index}-opt${optionIndex}" name="q-${index}" type="radio" value="${optionIndex}" class="custom-radio">
                            <span class="text-gray-800 dark:text-gray-300">${String.fromCharCode(65 + optionIndex)}. ${sanitizeString(option)}</span>
                        </label>`; 
                });
            }
            item.appendChild(optionsContainer);
            const explanation = args.explanation || `Đáp án đúng là lựa chọn ${String.fromCharCode(65 + parseInt(correctIndex))}.`;
            item.appendChild(createFeedbackDiv(`<span class="font-bold">Giải thích:</span> ${sanitizeString(explanation)}`));
            return item;
        }

        function renderFillInTheBlank(args, index) {
            const title = `<strong>Câu ${index}:</strong>`;
            const item = createQuestionItem('', index);
            item.dataset.type = 'fib';
            item.dataset.correct = sanitizeString(args.correctAnswer);
            const questionP = item.querySelector('div'); 
            const questionText = sanitizeString(args.question);

            const renderInput = `<input type="text" class="inline-block w-48 border-b-2 border-gray-300 dark:border-gray-600 focus:border-indigo-500 bg-transparent outline-none text-center mx-2" placeholder="điền vào đây">`;

            if (questionText.includes('___')) {
                questionP.innerHTML = `${title} ${questionText.replace('___', renderInput)}`;
            } else {
                questionP.innerHTML = `${title} ${questionText} ${renderInput}`;
            }

            item.appendChild(createFeedbackDiv(`<span class="font-bold">Giải thích:</span> ${sanitizeString(args.explanation || `Đáp án đúng là "${args.correctAnswer}".`)}`));
            return item;
        }

        function renderTrueFalse(args, index) {
            const title = `<strong>Câu ${index}:</strong> ${sanitizeString(args.statement)}`;
            const item = createQuestionItem(title, index); item.dataset.type = 'tf'; item.dataset.correct = sanitizeString(String(args.isCorrect));
            item.innerHTML += `<div class="flex space-x-4 mt-4">
                <label for="q${index}-true" class="option-label w-1/2"><input id="q${index}-true" name="q-${index}" type="radio" value="true" class="custom-radio"><span class="text-gray-800 dark:text-gray-300">Đúng</span></label>
                <label for="q${index}-false" class="option-label w-1/2"><input id="q${index}-false" name="q-${index}" type="radio" value="false" class="custom-radio"><span class="text-gray-800 dark:text-gray-300">Sai</span></label>
            </div>`;
            item.appendChild(createFeedbackDiv(`<span class="font-bold">Giải thích:</span> ${sanitizeString(args.explanation || `Đáp án đúng là ${args.isCorrect ? 'Đúng' : 'Sai'}.`)}`));
            return item;
        }
        
        function renderMatching(args, index) {
            const title = `<strong>Câu ${index}:</strong> ${sanitizeString(args.title)}`;
            const item = createQuestionItem(title, index);
            item.dataset.type = 'matching';
            const correctMapping = args.columnA.map((itemA, idx) => ({ itemA: sanitizeString(itemA), itemB: sanitizeString(args.columnB[idx]) }));
            item.dataset.correct = JSON.stringify(correctMapping);

            const shuffledB = [...args.columnB].map(b => sanitizeString(b)).sort(() => Math.random() - 0.5);
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mt-4';
            
            const colADiv = document.createElement('div');
            colADiv.className = 'space-y-3';
            const colBDiv = document.createElement('div');
            colBDiv.className = 'space-y-3';

            args.columnA.forEach((itemA, idx) => {
                colADiv.innerHTML += `<div class="p-3 bg-gray-100 dark:bg-gray-800 rounded-md flex items-center" data-item-a="${sanitizeString(itemA)}"><span class="font-semibold mr-2">${idx + 1}.</span> ${sanitizeString(itemA)}</div>`;
            });

            shuffledB.forEach((itemB, idx) => {
                colBDiv.innerHTML += `<div class="sortable-item p-3 bg-gray-100 dark:bg-gray-800 rounded-md flex items-center cursor-grab" draggable="true" data-item-b="${itemB}"><i data-lucide="grip-vertical" class="w-5 h-5 mr-3 text-gray-500"></i><span class="item-text">${itemB}</span></div>`;
            });
            
            grid.innerHTML = `
                <div class="space-y-4">
                    <h4 class="font-semibold">Cột A</h4>
                    <div class="space-y-2" id="col-a-container">${colADiv.innerHTML}</div>
                </div>
                <div class="space-y-4">
                    <h4 class="font-semibold">Cột B (Kéo thả để nối)</h4>
                    <div class="sortable-list space-y-2 min-h-[100px] p-2 rounded-lg bg-gray-200 dark:bg-gray-700/50">${colBDiv.innerHTML}</div>
                </div>
            `;

            item.appendChild(grid);
            addDragDropHandlers(grid.querySelector('.sortable-list'));
            item.appendChild(createFeedbackDiv(""));
            return item;
        }

        function renderSorting(args, index) {
            const title = `<strong>Câu ${index}:</strong> ${sanitizeString(args.title)}`;
            const item = createQuestionItem(title, index); item.dataset.type = 'sorting'; 
            const sanitizedItems = args.items.map(i => sanitizeString(i));
            item.dataset.correct = JSON.stringify(sanitizedItems);
            
            const list = document.createElement('div'); list.className = 'sortable-list space-y-2 mt-4 p-2 rounded-lg bg-gray-100 dark:bg-gray-800';
            const shuffledItems = [...sanitizedItems].sort(() => Math.random() - 0.5);
            shuffledItems.forEach(text => { 
                list.innerHTML += `<div class="sortable-item p-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-md flex items-center cursor-grab shadow-sm" draggable="true"><i data-lucide="grip-vertical" class="w-5 h-5 mr-3 text-gray-500"></i><span class="item-text">${text}</span></div>`; 
            });
            item.appendChild(list);
            item.appendChild(createFeedbackDiv(""));
            addDragDropHandlers(list);
            return item;
        }

        function renderShortAnswer(args, index) {
            const title = `<strong>Câu ${index}:</strong> ${args.question}`;
            const item = createQuestionItem(title, index); item.dataset.type = 'saq';
            item.innerHTML += `<textarea class="input-base mt-2 w-full" rows="4" placeholder="Viết câu trả lời của bạn..."></textarea>`;
            item.appendChild(createFeedbackDiv(`<span class="font-bold">Gợi ý đáp án:</span> ${sanitizeString(args.suggestedAnswer || "Đây là câu hỏi mở.")}`));
            return item;
        }
        
        // --- Modes ---
        function renderPracticeMode(questionsToRender) {
            exerciseListContainer.innerHTML = '';
            let questionCounter = 0;
            questionsToRender.forEach((item, index) => {
                const isListeningQuestion = currentQuizData.type === 'listening';
                const args = isListeningQuestion ? item : item.args;
                const name = isListeningQuestion ? 'createMultipleChoiceQuestion' : item.name;
                const renderFunction = renderers[name];
                
                if (renderFunction) {
                    if (name !== 'reading_passage') {
                        questionCounter++;
                    }
                    const element = renderFunction(args, questionCounter);
                    element.dataset.mainIndex = index;
                    exerciseListContainer.appendChild(element);
                }
            });
            practiceFooter.classList.remove('hidden');
            practiceActionsContainer.classList.add('hidden');
            checkAllAnswersButton.style.display = 'inline-flex';
            lucide.createIcons();
            renderMath(exerciseListContainer);
        }

        function renderInteractiveMode(questionsToRender) {
            const passageHost = document.getElementById('interactive-passage-host');
            passageHost.innerHTML = '';
            let actualQuestions = questionsToRender;

            if (questionsToRender[0] && questionsToRender[0].name === 'reading_passage') {
                const passageElement = renderReadingPassage(questionsToRender[0].args);
                passageHost.appendChild(passageElement);
                actualQuestions = questionsToRender.slice(1); 
            }

            allQuestions = actualQuestions; 
            currentQuestionIndex = 0;
            score = 0;
            sessionResults = [];

            if (allQuestions.length > 0) {
                 displayCurrentInteractiveQuestion();
            } else {
                if (passageHost.innerHTML !== '') { 
                     updateStatus('error', 'Bài đọc được tạo nhưng không có câu hỏi nào. Vui lòng thử lại.');
                     interactiveFooter.innerHTML = `<button id="change-settings-btn-error" class="btn btn-secondary">Đổi cài đặt</button>`;
                     document.getElementById('change-settings-btn-error').addEventListener('click', () => switchView('controls'));
                } else {
                    updateStatus('error', 'Không có bài tập hợp lệ nào được tạo.');
                    switchView('controls');
                }
            }
        }

        function displayCurrentInteractiveQuestion() {
            interactiveQuestionHost.innerHTML = ''; 
            interactiveFooter.innerHTML = '';
            interactiveQuestionHost.classList.remove('fade-in'); 
            void interactiveQuestionHost.offsetWidth; 
            interactiveQuestionHost.classList.add('fade-in');
            
            const itemData = allQuestions[currentQuestionIndex];
            const name = itemData.name;
            const args = itemData.args;
            const renderFunction = renderers[name];
            
            if (renderFunction) {
                const questionNumber = currentQuestionIndex + 1;
                const element = renderFunction(args, questionNumber);
                interactiveQuestionHost.appendChild(element);
            }

            const checkButton = document.createElement('button');
            checkButton.id = 'interactive-check-btn';
            checkButton.className = 'btn btn-primary bg-blue-600 hover:bg-blue-700';
            checkButton.innerHTML = 'Kiểm tra';
            checkButton.disabled = true;
            interactiveFooter.appendChild(checkButton);
            
            const enableButton = () => checkButton.disabled = false;
            interactiveQuestionHost.addEventListener('change', enableButton, { once: true });
            interactiveQuestionHost.addEventListener('input', enableButton, { once: true });
            interactiveQuestionHost.addEventListener('dragend', enableButton, { once: true });
            checkButton.addEventListener('click', () => checkInteractiveAnswer(currentQuestionIndex));

            updateProgress();
            lucide.createIcons();
            renderMath(interactiveQuestionHost);
        }

        function checkInteractiveAnswer(questionIndex) {
            const questionItem = interactiveQuestionHost.querySelector('.question-item');
            const { isCorrect, isGraded, userAnswer } = checkSingleAnswer(questionItem, true, questionIndex);
            
            sessionResults.push({
                question: allQuestions[questionIndex],
                userAnswer: userAnswer,
                isCorrect: isCorrect
            });

            if (isGraded && isCorrect) { score++; confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
            questionItem.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
            questionItem.querySelectorAll('.sortable-item').forEach(el => el.draggable = false);
            
            const continueButton = document.createElement('button');
            continueButton.id = 'interactive-continue-btn';
            let btnClass = 'btn text-white ';
            if (!isGraded) { btnClass += 'bg-blue-600 hover:bg-blue-700'; } 
            else { btnClass += isCorrect ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'; }
            continueButton.className = btnClass;
            continueButton.innerHTML = 'Tiếp tục <i data-lucide="arrow-right" class="inline-block w-4 h-4 ml-1"></i>';
            interactiveFooter.innerHTML = ''; interactiveFooter.appendChild(continueButton);
            continueButton.addEventListener('click', showNextQuestion);
            lucide.createIcons();
            renderMath(interactiveQuestionHost);
        }

        function showNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < allQuestions.length) { displayCurrentInteractiveQuestion(); } 
            else { showSummary(); }
        }

        function updateProgress() {
            const totalQuestions = allQuestions.length;
            const progress = totalQuestions > 0 ? ((currentQuestionIndex + 1) / totalQuestions) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Câu ${currentQuestionIndex + 1} / ${totalQuestions}`;
        }

        function showSummary() {
            switchView('summary');
            const gradableQuestions = allQuestions.length;
            const percentage = gradableQuestions > 0 ? (score / gradableQuestions) * 100 : 0;
            summaryText.textContent = `Bạn đã trả lời đúng ${score} / ${gradableQuestions} câu.`;
            summaryProgressBar.style.width = `${percentage}%`;

            currentTestResult.score = score;
            currentTestResult.totalGradable = gradableQuestions;
            saveTestResult();
        }

        // --- Grading Logic ---
        function checkSingleAnswer(q, showFeedback = false, questionIndex = -1) {
            let isCorrect = false; 
            let isGraded = true;
            let feedbackHTML = '';
            let userAnswer = null;

            switch (q.dataset.type) {
                case 'mcq':
                    const selectedRadioMCQ = q.querySelector('input:checked');
                    if(selectedRadioMCQ) {
                        userAnswer = q.querySelector(`label[for="${selectedRadioMCQ.id}"] span`).textContent.substring(3);
                    }
                    const correctIndexMCQ = parseInt(q.dataset.correct);
                    if (selectedRadioMCQ) {
                        isCorrect = parseInt(selectedRadioMCQ.value) === correctIndexMCQ;
                        if (showFeedback) {
                             const allLabels = q.querySelectorAll('.option-label');
                             allLabels.forEach((label, index) => {
                                 if (index === correctIndexMCQ) {
                                     label.classList.add('correct');
                                 } else if (label.contains(selectedRadioMCQ)) {
                                     label.classList.add('incorrect');
                                 }
                             });
                        }
                    }
                    break;

                case 'tf':
                    const selectedRadioTF = q.querySelector('input:checked');
                    if(selectedRadioTF) userAnswer = selectedRadioTF.value;
                    const isCorrectTF = q.dataset.correct === 'true';
                    if (selectedRadioTF) {
                        isCorrect = (selectedRadioTF.value === 'true') === isCorrectTF;
                        if (showFeedback) {
                            const userChoiceLabel = selectedRadioTF.closest('.option-label');
                            if (userChoiceLabel) userChoiceLabel.classList.add(isCorrect ? 'correct' : 'incorrect');
                            
                            const correctLabel = q.querySelector(`input[value="${isCorrectTF}"]`).closest('.option-label');
                            if (correctLabel && !correctLabel.classList.contains('correct')) {
                                correctLabel.classList.add('correct');
                            }
                        }
                    }
                    break;
                
                case 'fib':
                    const input = q.querySelector('input[type="text"]');
                    if (input) {
                        userAnswer = input.value;
                        isCorrect = input.value.trim().toLowerCase() === q.dataset.correct.toLowerCase();
                        if (showFeedback) { 
                            input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                            if (!isCorrect) {
                                const correctAnswerEl = document.createElement('span');
                                correctAnswerEl.className = 'text-green-600 dark:text-green-400 ml-2';
                                correctAnswerEl.textContent = `(Đáp án: ${q.dataset.correct})`;
                                input.after(correctAnswerEl);
                            }
                        }
                    }
                    break;

                case 'matching':
                    const listContainer = q.querySelector('.sortable-list');
                    const userOrderItems = listContainer.querySelectorAll('.sortable-item');
                    userAnswer = Array.from(userOrderItems).map(item => item.dataset.itemB).join(', ');
                    const correctMapping = JSON.parse(q.dataset.correct);
                    let correctMatches = 0;
                    
                    correctMapping.forEach((pair, idx) => {
                        const userItemB = userOrderItems[idx] ? userOrderItems[idx].dataset.itemB : null;
                        const isMatchCorrect = pair.itemB === userItemB;
                        if (isMatchCorrect) correctMatches++;

                        if (showFeedback) {
                            const itemAContainer = q.querySelector(`#col-a-container`).children[idx];
                            const itemBEl = userOrderItems[idx];

                            if (isMatchCorrect) {
                                if(itemAContainer) itemAContainer.classList.add('bg-green-100', 'dark:bg-green-900/50');
                                if(itemBEl) itemBEl.classList.add('bg-green-100', 'dark:bg-green-900/50');
                            } else {
                                if(itemAContainer) itemAContainer.classList.add('bg-red-100', 'dark:bg-red-900/50');
                                if(itemBEl) itemBEl.classList.add('bg-red-100', 'dark:bg-red-900/50');
                            }
                        }
                    });
                    isCorrect = correctMatches === correctMapping.length;
                    feedbackHTML = `<span class="font-bold">Đáp án đúng:</span><ul class="list-none mt-2 space-y-1">`;
                    correctMapping.forEach(item => { 
                        feedbackHTML += `<li>${item.itemA} &harr; ${item.itemB}</li>`;
                    });
                    feedbackHTML += `</ul>`;
                    break;

                case 'sorting':
                    const userOrder = Array.from(q.querySelectorAll('.sortable-item .item-text')).map(item => item.textContent);
                    userAnswer = userOrder.join(' -> ');
                    const correctOrder = JSON.parse(q.dataset.correct);
                    isCorrect = JSON.stringify(userOrder) === JSON.stringify(correctOrder);
                    feedbackHTML = `<span class="font-bold">Thứ tự đúng:</span><ol class="list-decimal list-inside mt-2 space-y-1">`;
                    correctOrder.forEach((item, i) => { 
                         feedbackHTML += `<li class="${userOrder[i] === item ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}">${item}</li>`; 
                    });
                    feedbackHTML += `</ol>`;
                    break;
                
                case 'saq': isGraded = false; break;
            }
            
            const feedbackDiv = q.querySelector('.feedback-box');
            if (showFeedback && feedbackDiv) {
                if (feedbackHTML) feedbackDiv.innerHTML = feedbackHTML;
                feedbackDiv.classList.remove('hidden');
                feedbackDiv.classList.add(isGraded ? (isCorrect ? 'correct' : 'incorrect') : 'info');
                
                if (isGraded && questionIndex !== -1) {
                    const button = document.createElement('button');
                    const questionData = allQuestions[questionIndex];
                    const args = questionData.args || questionData;

                    if (isCorrect) {
                        button.innerHTML = `<i data-lucide="sparkles" class="w-4 h-4 mr-2 inline-block"></i>Mở rộng kiến thức`;
                        button.className = 'btn bg-teal-600 hover:bg-teal-700 text-white text-sm mt-4';
                        button.onclick = () => requestExpandedKnowledge(args);
                    } else {
                        button.innerHTML = `<i data-lucide="shield-question" class="w-4 h-4 mr-2 inline-block"></i>Củng cố kiến thức`;
                        button.className = 'btn bg-purple-600 hover:bg-purple-700 text-white text-sm mt-4';
                        button.onclick = () => {
                            const finalUserAnswer = userAnswer || "(không chọn đáp án)";
                            requestReinforcement(args, finalUserAnswer);
                        };
                    }
                    feedbackDiv.appendChild(button);
                    lucide.createIcons();
                }
            }

            return { isCorrect, isGraded, userAnswer };
        }

        function checkAllPracticeAnswers() {
            let totalScore = 0; 
            let gradableQuestions = 0;
            sessionResults = [];

            exerciseListContainer.querySelectorAll('.question-item').forEach(q_element => {
                let mainIndex = parseInt(q_element.dataset.mainIndex, 10);
                
                if (q_element.dataset.type) { 
                    const result = checkSingleAnswer(q_element, true, mainIndex);
                    
                    const questionData = allQuestions[mainIndex];
                    sessionResults.push({
                        question: questionData.args || questionData,
                        userAnswer: result.userAnswer,
                        isCorrect: result.isCorrect
                    });

                    if (result.isGraded) { 
                        gradableQuestions++; 
                        if (result.isCorrect) totalScore++; 
                    }
                }
            });

            paperScore.innerHTML = `<strong>Điểm số:</strong> ${totalScore} / ${gradableQuestions}`;
            paperScore.classList.remove('hidden');
            
            practiceActionsContainer.classList.remove('hidden');
            checkAllAnswersButton.style.display = 'none';

            currentTestResult.score = totalScore;
            currentTestResult.totalGradable = gradableQuestions;
            saveTestResult();

            lucide.createIcons();
            renderMath(exerciseListContainer);
        }

        // --- Drag & Drop ---
        function addDragDropHandlers(list) {
            let draggingItem = null;
            list.querySelectorAll('.sortable-item').forEach(item => {
                item.addEventListener('dragstart', (e) => { 
                    draggingItem = item;
                    setTimeout(() => item.classList.add('opacity-50'), 0); 
                });
                item.addEventListener('dragend', () => { 
                    item.classList.remove('opacity-50');
                    draggingItem = null;
                });
            });
            list.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(list, e.clientY);
                if (draggingItem) {
                    if (afterElement == null) { list.appendChild(draggingItem); } 
                    else { list.insertBefore(draggingItem, afterElement); }
                }
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.sortable-item:not(.opacity-50)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
                else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- AUTHENTICATION & FIRESTORE ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loginContainer.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                userAvatar.src = user.photoURL;
                userName.textContent = user.displayName;
            } else {
                currentUser = null;
                loginContainer.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userInfo.classList.remove('flex');
            }
        });

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch((error) => console.error("Authentication error:", error));
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error("Sign out error:", error));
        });

        async function saveTestResult() {
            if (!currentUser) {
                summarySaveStatus.textContent = 'Đăng nhập để lưu kết quả của bạn.';
                return;
            }
            if (currentTestResult.totalGradable === undefined) return;

            summarySaveStatus.textContent = 'Đang lưu kết quả...';
            try {
                await addDoc(collection(db, "userResults"), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    createdAt: serverTimestamp(),
                    ...currentTestResult
                });
                summarySaveStatus.textContent = 'Kết quả đã được lưu thành công!';
            } catch (e) {
                console.error("Error adding document: ", e);
                summarySaveStatus.textContent = 'Lỗi khi lưu kết quả.';
            }
        }

        async function renderHistory() {
            switchView('history');
            historyLoadingSpinner.classList.remove('hidden');
            practiceHistoryList.innerHTML = '';
            interactiveHistoryList.innerHTML = '';
            noPracticeHistory.classList.add('hidden');
            noInteractiveHistory.classList.add('hidden');

            if (!currentUser) {
                noPracticeHistory.classList.remove('hidden');
                noPracticeHistory.textContent = 'Vui lòng đăng nhập để xem lịch sử.';
                noInteractiveHistory.classList.remove('hidden');
                noInteractiveHistory.textContent = 'Vui lòng đăng nhập để xem lịch sử.';
                historyLoadingSpinner.classList.add('hidden');
                return;
            }

            try {
                const q = query(collection(db, "userResults"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                let practiceCount = 0;
                let interactiveCount = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate().toLocaleString('vi-VN') || 'Không rõ ngày';
                    const scoreColor = data.score / data.totalGradable >= 0.5 ? 'text-green-500' : 'text-red-500';

                    const historyItemHTML = `
                        <div class="card p-4 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-200">${data.subject}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${data.topic}</p>
                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg ${scoreColor}">${data.score} / ${data.totalGradable}</p>
                                <p class="text-xs font-semibold text-gray-500 dark:text-gray-400">${data.mode === 'practice' ? 'Luyện tập' : 'Tương tác'}</p>
                            </div>
                        </div>
                    `;

                    if (data.mode === 'practice') {
                        practiceHistoryList.innerHTML += historyItemHTML;
                        practiceCount++;
                    } else {
                        interactiveHistoryList.innerHTML += historyItemHTML;
                        interactiveCount++;
                    }
                });

                if (practiceCount === 0) noPracticeHistory.classList.remove('hidden');
                if (interactiveCount === 0) noInteractiveHistory.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching history: ", error);
                noPracticeHistory.classList.remove('hidden');
                noPracticeHistory.textContent = 'Lỗi khi tải lịch sử.';
            } finally {
                historyLoadingSpinner.classList.add('hidden');
            }
        }

        // --- HELPERS & INITIALIZATION ---
        function updateStatus(type, message) { const colors = { 'success': 'text-green-600 dark:text-green-400', 'error': 'text-red-600 dark:text-red-400', 'info': 'text-gray-600 dark:text-gray-400' }; statusMessage.textContent = message; statusMessage.className = `mt-6 text-center font-semibold ${colors[type] || 'text-gray-600 dark:text-gray-400'}`; }
        function setLoadingState(isLoading) { generateButton.disabled = isLoading; const icon = generateButton.querySelector('i'); if(icon) icon.classList.toggle('hidden', isLoading); buttonText.classList.toggle('hidden', isLoading); buttonSpinner.classList.toggle('hidden', !isLoading); if (isLoading) updateStatus('info', 'AI đang làm việc, vui lòng chờ trong giây lát...'); }
        
        function updateDynamicControls() {
            const subject = subjectSelect.value;
            skillSelectContainer.classList.add('hidden');
            levelSelectContainer.classList.add('hidden');
            mathLevelSelectContainer.classList.add('hidden');
            
            let templateKey = subject;
            if (subject === 'english') {
                const skill = skillSelect.value;
                templateKey = `english_${skill}`;
                skillSelectContainer.classList.remove('hidden');
                levelSelectContainer.classList.remove('hidden');
            } else if (subject === 'mathematics') {
                templateKey = 'mathematics';
                mathLevelSelectContainer.classList.remove('hidden');
            }

            dynamicControlsContainer.innerHTML = controlTemplates[templateKey] || controlTemplates.general;
            lucide.createIcons();
        }

        // --- AUDIO PLAYBACK LOGIC ---
        function playSpeech(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            audioState.isPaused = false;
            
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            let selectedVoice = voices.find(voice => voice.name === 'Google US English' || voice.name === 'Microsoft David - English (United States)');
            if (!selectedVoice) {
                selectedVoice = voices.find(voice => voice.lang.startsWith('en-')) || voices[0];
            }
            utterance.voice = selectedVoice;
            utterance.rate = 0.9;
            
            utterance.onstart = () => {
                playAudioBtn.innerHTML = `<i data-lucide="pause" class="w-6 h-6"></i>`;
                lucide.createIcons();
                audioStatus.textContent = "Đang phát...";
            };
            
            utterance.onend = () => {
                if (!audioState.isPaused) {
                    playAudioBtn.innerHTML = `<i data-lucide="play" class="w-6 h-6"></i>`;
                    lucide.createIcons();
                    audioStatus.textContent = "Nghe lại";
                }
            };
            
            audioState.utterance = utterance;
            synth.speak(utterance);
        }

        function setupAudioPlayer() {
            playAudioBtn.innerHTML = `<i data-lucide="play" class="w-6 h-6"></i>`;
            lucide.createIcons();
            audioStatus.textContent = "Nhấn để nghe";
            
            playAudioBtn.onclick = () => {
                if (synth.speaking && !synth.paused) {
                    synth.pause();
                    audioState.isPaused = true;
                    playAudioBtn.innerHTML = `<i data-lucide="play" class="w-6 h-6"></i>`;
                    lucide.createIcons();
                    audioStatus.textContent = "Đã tạm dừng";
                } else if (synth.paused) {
                    synth.resume();
                    audioState.isPaused = false;
                    playAudioBtn.innerHTML = `<i data-lucide="pause" class="w-6 h-6"></i>`;
                    lucide.createIcons();
                    audioStatus.textContent = "Đang phát...";
                } else {
                    playSpeech(currentQuizData.raw.script);
                }
            };
        }

        // RE-ADDED: Functions for Expanded Knowledge & Reinforcement
        async function requestExpandedKnowledge(questionArgs) {
            lessonModal.classList.add('active');
            lessonContent.innerHTML = '<div class="spinner mx-auto"></div>';
            lessonTitle.textContent = "Mở rộng kiến thức";
            lessonTitle.className = "text-2xl font-bold text-teal-600 dark:text-teal-400";
            
            try {
                const prompt = getExpansionPrompt(questionArgs);
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const lessonData = extractAndParseJson(response.text());

                if (!lessonData) { throw new Error("AI không trả về bài học hợp lệ."); }
                displayExpandedKnowledge(lessonData, subjectSelect.value);

            } catch (error) {
                lessonContent.innerHTML = `<p class="text-center text-red-500">Rất tiếc, không thể tạo bài học ngay lúc này. Lỗi: ${error.message}</p>`;
            }
        }

        function displayExpandedKnowledge(data, subject) {
            lessonTitle.textContent = data.conceptTitle;
            let examplesHTML;
            if (subject === 'english') {
                examplesHTML = (data.examples || []).map(ex => `
                    <li class="p-2 rounded-md bg-white dark:bg-gray-800">
                        <p class="font-semibold text-sky-700 dark:text-sky-300">${marked.parse(ex.en || '')}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 italic">→ ${marked.parse(ex.vi || '')}</p>
                    </li>
                `).join('');
            } else {
                examplesHTML = (data.examples || []).map(ex => `
                    <li class="p-2 rounded-md bg-white dark:bg-gray-800">
                        <p class="text-gray-700 dark:text-gray-300">${marked.parse(ex || '')}</p>
                    </li>
                `).join('');
            }

            lessonContent.innerHTML = `
                <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-md font-bold text-gray-800 dark:text-gray-200 mb-2">Giải thích sâu hơn</h4>
                    <div class="text-gray-700 dark:text-gray-300 space-y-2 prose">${marked.parse(data.conceptExplanation || '')}</div>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-md font-bold text-gray-800 dark:text-gray-200 mb-2">Ví dụ minh họa</h4>
                    <ul class="space-y-2">${examplesHTML}</ul>
                </div>
                <div class="bg-amber-100 dark:bg-amber-900/50 p-3 rounded-lg border border-amber-200 dark:border-amber-700">
                    <h4 class="text-md font-bold text-amber-800 dark:text-amber-200 mb-1">💡 Mẹo ghi nhớ</h4>
                    <div class="text-amber-700 dark:text-amber-300 prose">${marked.parse(data.practiceTip || '')}</div>
                </div>
            `;
            renderMath(lessonContent);
        }
        
        async function requestReinforcement(questionArgs, userAnswer) {
            lessonModal.classList.add('active');
            lessonContent.innerHTML = '<div class="spinner mx-auto"></div>';
            lessonTitle.textContent = "Củng cố kiến thức";
            lessonTitle.className = "text-2xl font-bold text-purple-600 dark:text-purple-400";

            try {
                const prompt = getReinforcementPrompt(questionArgs, userAnswer);
                const result = await model.generateContent(prompt);
                const response = await result.response;
                const lessonData = extractAndParseJson(response.text());

                if (!lessonData) { throw new Error("AI không trả về bài học hợp lệ."); }
                displayReinforcement(lessonData, subjectSelect.value);

            } catch (error) {
                lessonContent.innerHTML = `<p class="text-center text-red-500">Rất tiếc, không thể tạo bài học ngay lúc này. Lỗi: ${error.message}</p>`;
            }
        }

        function displayReinforcement(data, subject) {
            lessonTitle.textContent = data.conceptTitle;
            let examplesHTML;
            if (subject === 'english') {
                examplesHTML = (data.examples || []).map(ex => `
                    <li class="p-2 rounded-md bg-white dark:bg-gray-800">
                        <p class="font-semibold text-sky-700 dark:text-sky-300">${marked.parse(ex.en || '')}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 italic">→ ${marked.parse(ex.vi || '')}</p>
                    </li>
                `).join('');
            } else {
                 examplesHTML = (data.examples || []).map(ex => `
                    <li class="p-2 rounded-md bg-white dark:bg-gray-800">
                        <p class="text-gray-700 dark:text-gray-300">${marked.parse(ex || '')}</p>
                    </li>
                `).join('');
            }

            lessonContent.innerHTML = `
                <div class="bg-red-100 dark:bg-red-900/50 p-3 rounded-lg border border-red-200 dark:border-red-700">
                    <h4 class="text-md font-bold text-red-800 dark:text-red-200 mb-1">Phân tích lỗi sai</h4>
                    <div class="text-red-700 dark:text-red-300 prose">${marked.parse(data.mistakeAnalysis || '')}</div>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-md font-bold text-gray-800 dark:text-gray-200 mb-2">Giải thích khái niệm</h4>
                    <div class="text-gray-700 dark:text-gray-300 space-y-2 prose">${marked.parse(data.conceptExplanation || '')}</div>
                </div>
                <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
                    <h4 class="text-md font-bold text-gray-800 dark:text-gray-200 mb-2">Ví dụ minh họa</h4>
                    <ul class="space-y-2">${examplesHTML}</ul>
                </div>
                <div class="bg-amber-100 dark:bg-amber-900/50 p-3 rounded-lg border border-amber-200 dark:border-amber-700">
                    <h4 class="text-md font-bold text-amber-800 dark:text-amber-200 mb-1">💡 Mẹo ghi nhớ</h4>
                    <div class="text-amber-700 dark:text-amber-300 prose">${marked.parse(data.practiceTip || '')}</div>
                </div>
            `;
            renderMath(lessonContent);
        }
        
        // --- EVENT LISTENERS ---
        function updateButtonText() {
            const mode = modeSelect.value;
            buttonText.textContent = mode === 'practice' ? 'Bắt đầu Luyện tập' : 'Bắt đầu Tương tác';
        }

        modePracticeBtn.addEventListener('click', () => { modeSelect.value = 'practice'; modePracticeBtn.classList.add('bg-white', 'dark:bg-gray-900', 'text-indigo-600', 'dark:text-indigo-400', 'shadow'); modePracticeBtn.classList.remove('text-gray-500', 'dark:text-gray-400'); modeInteractiveBtn.classList.remove('bg-white', 'dark:bg-gray-900', 'text-indigo-600', 'dark:text-indigo-400', 'shadow'); modeInteractiveBtn.classList.add('text-gray-500', 'dark:text-gray-400'); updateButtonText(); });
        modeInteractiveBtn.addEventListener('click', () => { modeSelect.value = 'interactive'; modeInteractiveBtn.classList.add('bg-white', 'dark:bg-gray-900', 'text-indigo-600', 'dark:text-indigo-400', 'shadow'); modeInteractiveBtn.classList.remove('text-gray-500', 'dark:text-gray-400'); modePracticeBtn.classList.remove('bg-white', 'dark:bg-gray-900', 'text-indigo-600', 'dark:text-indigo-400', 'shadow'); modePracticeBtn.classList.add('text-gray-500', 'dark:text-gray-400'); updateButtonText(); });
        subjectSelect.addEventListener('change', updateDynamicControls);
        skillSelect.addEventListener('change', updateDynamicControls); 
        
        generateButton.addEventListener('click', startPractice); 
        checkAllAnswersButton.addEventListener('click', checkAllPracticeAnswers);
        getFeedbackBtn.addEventListener('click', getWritingFeedback);
        writingInput.addEventListener('input', () => {
            const text = writingInput.value;
            const count = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            wordCount.textContent = `${count} từ`;
        });
        showTranscriptBtn.addEventListener('click', () => {
            transcriptContainer.classList.toggle('hidden');
            showTranscriptBtn.textContent = transcriptContainer.classList.contains('hidden') ? 'Hiện lời thoại' : 'Ẩn lời thoại';
        });
        
        const handleRestart = () => {
             if (generatedExercisesCache.length === 0) {
                 alert("Không có bài tập nào để làm lại. Vui lòng tạo bài tập trước.");
                 return;
             }
             resetQuizState();
             
             if (modeSelect.value === 'practice') {
                renderPracticeMode(generatedExercisesCache);
            } else {
                renderInteractiveMode(generatedExercisesCache);
            }
             switchView('exercise');
        };
        const handleChangeSettings = () => switchView('controls');
        restartQuizBtn.addEventListener('click', handleRestart);
        changeSettingsBtn.addEventListener('click', handleChangeSettings);
        restartPracticeBtn.addEventListener('click', handleRestart);
        changeSettingsFromPracticeBtn.addEventListener('click', handleChangeSettings);
        restartWritingBtn.addEventListener('click', startWritingPractice);
        changeSettingsFromWritingBtn.addEventListener('click', handleChangeSettings);
        
        sendTextBtn.addEventListener('click', handleConversationResponse);
        conversationTextInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleConversationResponse();
            }
        });
        endConversationBtn.addEventListener('click', endConversationAndGetFeedback);

        historyBtn.addEventListener('click', renderHistory);
        backToMainBtn.addEventListener('click', () => switchView('controls'));

        practiceTab.addEventListener('click', () => {
            practiceTab.classList.add('active');
            interactiveTab.classList.remove('active');
            practiceHistoryContent.classList.remove('hidden');
            interactiveHistoryContent.classList.add('hidden');
        });

        interactiveTab.addEventListener('click', () => {
            interactiveTab.classList.add('active');
            practiceTab.classList.remove('active');
            interactiveHistoryContent.classList.remove('hidden');
            practiceHistoryContent.classList.add('hidden');
        });

        closeLessonModal.addEventListener('click', () => lessonModal.classList.remove('active'));
        lessonModal.addEventListener('click', (event) => {
            if (event.target === lessonModal) {
                lessonModal.classList.remove('active');
            }
        });
        
        // --- DARK MODE TOGGLE ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load theme from local storage
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            try {
                model = getGenerativeModel(getAI(app), { model: GEMINI_MODEL_NAME });
                updateStatus('success', "Mô hình AI đã sẵn sàng!");
                updateDynamicControls();
                renderMath();
            } catch (e) {
                updateStatus('error', `Lỗi khởi tạo AI: ${e.message}`);
            }
            lucide.createIcons();
        });
    </script>
</body>
</html>
